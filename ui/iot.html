<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/page/employee.css">
    <title>HAPPYHOME.VN - Kiến tạo mái ấm gia đình</title>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="header__left">
                <div class="header__sibar"></div>
            </div>
            <div class="header__right">
                <div>
                    <div class="page__header--title heading">Hệ thống giám sát nhà từ xa</div>
                </div>
                <div class="user">
                    <div class="user__name" id="nameUser"></div>
                    <div class="user__avatar"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="main">
        <div class="menu">
            <div class="item icon__dashboard item--selected" name="item_dashboard">Tổng quan</div>
            <div class="item icon__temperature" name="item_temperature" onclick="renderTemperature($('#content_temperature'))">Nhiệt độ</div>
            <div class="item icon__humidity" name="item_humidity" onclick="renderHumidity($('#content_humidity'))">Độ ẩm</div>
        </div>

        <div class="content">
            <div class="page__header">
                <div class="page__toolbar--left">
                    <select name="" id="roomListing" onchange="getDeviceByRoom()">
                        <!-- Dynamic room options will be added here -->
                    </select>
                </div>
            </div>

            <div class="page__content" id="content_dashboard">
                <br>
                <div style="display: flex; position: relative;">
                    <div class="page__content--title">Bóng đèn 1:</div>
                    <button id="bong1" class="button__icon button__icon--lamp button__icon--lamp--on" name="bong1">Hoạt động</button>
                </div>
                <br>
                <br>
                <div style="display: flex; position: relative;">
                    <div class="page__content--title">Bóng đèn 2:</div>
                    <button id="bong2" class="button__icon button__icon--lamp button__icon--lamp--off" name="bong2">Tắt</button>
                </div>
                <br>
                <br>
                <div id="temperature" class="page__content--title" style="color: red;">Nhiệt độ:</div>
                <br>
                <br>
                <div id="humidity" class="page__content--title" style="color: blue;">Độ ẩm:</div>
            </div>

            <div class="page__content" id="content_temperature">
                <br>
                <div class="page__header--title heading" style="font-size: 16px;">Thống kê nhiệt độ</div>
                <br>
                <div class="chartContainer"></div>
            </div>

            <div class="page__content" id="content_humidity">
                <br>
                <div class="page__header--title heading" style="font-size: 16px;">Thống kê độ ẩm</div>
                <br>
                <div class="chartContainer"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="./js/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="./js/jquery.canvasjs.min.js"></script>
    <script type="text/javascript" src="./js/mqttws31.js"></script>
    <script src="./js/pages/pub.js"></script>
    <script src="./js/pages/sub.js"></script>
    <script src="./js/pages/iot.js"></script>

    <script>
        var token = localStorage.getItem("token");
        var baseUrl = "http://localhost:3000";

        // Load rooms dynamically
        $.ajax({
            url: baseUrl + "/api/room",
            type: "get",
            dataType: "json",   
            contentType: "application/json; charset=UTF-8",
            headers: {
                'Authorization': token
            },
            success: function(data) {
                data.forEach(room => {
                    $('#roomListing').append($('<option>', {
                        value: room._id,
                        text: room.name
                    }));
                });
                getDeviceByRoom();
            }
        });

        // Set user name from localStorage
        $("#nameUser").text(localStorage.getItem("nameUser"));

        async function getDeviceByRoomId(roomId) {
            $.ajax({
                url: baseUrl + `/api/device/room/${roomId}`,
                type: "get",
                dataType: "json",   
                contentType: "application/json; charset=UTF-8",
                headers: {
                    'Authorization': token
                },
                success: function(data) {
                    const leds = data.leds;
                    const sensors = data.sensors;
                    let dataDevice = "";
                    $("#content_dashboard").empty();

                    // Update for LED devices
                    leds.forEach(led => {
                        let str = `<div style="display: flex; position: relative;">`;
                        str += `<div class="page__content--title">${led.deviceName}: </div>`;
                        str += `<button id="${led._id}" class="button__icon button__icon--lamp ${led.status === 'ON' ? 'button__icon--lamp--on' : 'button__icon--lamp--off'}" onclick="changeLampStatus('${led._id}')">${led.status === 'ON' ? 'Hoạt động' : 'Tắt'}</button>`;
                        str += `</div><br><br>`;
                        dataDevice += str;
                    });

                    // Update for sensor devices
                    sensors.forEach(sensor => {
                        if (sensor.deviceType.name === "humidity_sensors") {
                            dataDevice += `<br><div id="${sensor._id}" class="page__content--title" style="color: blue;">${sensor.deviceName}: ${sensor.value}%</div><br>`;
                        }
                        if (sensor.deviceType.name === "temperature_sensors") {
                            dataDevice += `<br><div id="${sensor._id}" class="page__content--title" style="color: red;">${sensor.deviceName}: ${sensor.value.toFixed(2)}°C</div><br>`;
                        }
                    });

                    $("#content_dashboard").append(dataDevice);
                }
            });
        }

        async function getDeviceByRoom() {
            const roomId = $("#roomListing :selected").val();
            const tab = localStorage.getItem("tab");
            if (tab === "temperature") {
                renderTemperature($("#content_temperature"));
            } else if (tab === "humidity") {
                renderHumidity($("#content_humidity"));
            } else {
                await getDeviceByRoomId(roomId);
            }
        }

        function changeLampStatus(deviceId) {
            // Add your code here to change lamp status (ON/OFF)
            console.log('Changing lamp status for device', deviceId);
        }
    </script>
</body>
</html>
